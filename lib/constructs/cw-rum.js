"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CwRumAppMonitor = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const cognito = require("aws-cdk-lib/aws-cognito");
const iam = require("aws-cdk-lib/aws-iam");
const rum = require("aws-cdk-lib/aws-rum");
const customResources = require("aws-cdk-lib/custom-resources");
const constructs_1 = require("constructs");
function cwrumCustomResource(name) {
    const on_create_aws_sdk_call = new customResources.AwsSdkCall(physical_resource_id = customResources.PhysicalResourceId.fromResponse("AppMonitor.Id"), service, "RUM", action, "getAppMonitor", // https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/RUM.html//getAppMonitor-property // noqa: E501
    parameters = {
        "Name": name,
    });
    const custom_resource = new customResources.AwsCustomResource(this, "CwRum_custom_resource", {
        policy: customResources.AwsCustomResourcePolicy.fromSdkCalls(resources, customResources.AwsCustomResourcePolicy.ANY_RESOURCE),
        onCreate: on_create_aws_sdk_call,
        onUpdate: on_create_aws_sdk_call,
    });
    const app_monitor_id = custom_resource.getResponseField("AppMonitor.Id");
    return app_monitor_id;
}
class CwRumAppMonitor extends constructs_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        const stack = aws_cdk_lib_1.Stack.of(this);
        // RUM Cognito Identity Pool
        const rum_identity_pool = new cognito.CfnIdentityPool(this, "CwRumIdentityPool", {
            allowUnauthenticatedIdentities: true,
            allowClassicFlow: true
        });
        // RUM Cognito Identity Pool Unauthenitcated Role
        const rum_id_pool_unauth_user_role = new iam.Role(this, "CwRumCognitoDefaultUnauthenticatedRole", {
            assumedBy: new iam.FederatedPrincipal("cognito-identity.amazonaws.com", {
                "StringEquals": {
                    "cognito-identity.amazonaws.com:aud": rum_identity_pool.ref,
                },
                "ForAnyValue:StringLike": {
                    "cognito-identity.amazonaws.com:amr": "unauthenticated",
                },
            }, "sts:AssumeRoleWithWebIdentity"),
        });
        rum_id_pool_unauth_user_role.applyRemovalPolicy(aws_cdk_lib_1.RemovalPolicy.DESTROY);
        new cognito.CfnIdentityPoolRoleAttachment(this, "CwRumIdentityPoolRoleAttachment", {
            identityPoolId: rum_identity_pool.ref,
            roles: {
                "unauthenticated": rum_id_pool_unauth_user_role.roleArn,
            },
        });
        // RUM App Monitor
        const cfn_app_monitor = new rum.CfnAppMonitor(this, "CfnAppMonitor", {
            domain: props.domainName,
            name: props.domainName,
            appMonitorConfiguration: {
                allowCookies: props.allowCookies,
                enableXRay: props.enableXray,
                guestRoleArn: rum_id_pool_unauth_user_role.roleArn,
                identityPoolId: rum_identity_pool.ref,
                sessionSampleRate: props.sessionSampleRate,
                telemetries: props.telemetries,
            }
        });
        const rum_policy = new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: ["rum:PutRumEvents"],
            resources: [
                `arn:aws:rum:${stack.region}:${stack.account}:appmonitor/${cfn_app_monitor.ref}`
            ],
        });
        rum_id_pool_unauth_user_role.addToPolicy(rum_policy);
        const rum_app_monitor_id = cwrumCustomResource(cfn_app_monitor.ref);
        // this.name = cfn_app_monitor.ref // TODO is this export needed?
        cfn_app_monitor.appMonitorConfiguration;
        // TODO fix this
        const rum_script = `<script>(function(n,i,v,r,s,c,x,z){{x=window.AwsRumClient={{q:[],n:n,i:i,v:v,r:r,c:c}};window[n]=function(c,p){{x.q.push({{c:c,p:p}});}};z=document.createElement('script');z.async=true;z.src=s;document.head.insertBefore(z,document.getElementsByTagName('script')[0]);}})('cwr','${rum_app_monitor_id}','1.0.0','${stack.region}','https://client.rum.us-east-1.amazonaws.com/1.0.2/cwr.js',{{sessionSampleRate:1,guestRoleArn:\"${rum_id_pool_unauth_user_role.roleArn}\",identityPoolId:\"${rum_identity_pool.ref}\",endpoint:\"https://dataplane.rum.eu-west-1.amazonaws.com\",telemetries:${rum_app_monitor_config_telemetries},allowCookies:${rum_app_monitor_config_cookies},enableXRay:${rum_app_monitor_config_x_ray}}});</script>`;
        rum_app_monitor_config_x_ray = str(cfn_app_monitor.app_monitor_configuration.enable_x_ray).lower(),
            rum_app_monitor_config_cookies = str(cfn_app_monitor.app_monitor_configuration.allow_cookies).lower(),
            rum_app_monitor_config_telemetries = str(cfn_app_monitor.app_monitor_configuration.telemetries),
        ;
        // this.name = cfn_app_monitor.ref // TODO is this export needed?
        // this.id = rum_app_monitor_id // TODO is this export needed?
        // this.script = rum_script // TODO is this export needed?
    }
}
exports.CwRumAppMonitor = CwRumAppMonitor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3ctcnVtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY3ctcnVtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDZDQUFtRDtBQUNuRCxtREFBbUQ7QUFDbkQsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUMzQyxnRUFBZ0U7QUFHaEUsMkNBQXVDO0FBRXZDLFNBQVMsbUJBQW1CLENBQUMsSUFBWTtJQUVyQyxNQUFNLHNCQUFzQixHQUFHLElBQUksZUFBZSxDQUFDLFVBQVUsQ0FDekQsb0JBQW9CLEdBQUcsZUFBZSxDQUFDLGtCQUFrQixDQUFDLFlBQVksQ0FDbEUsZUFBZSxDQUNsQixFQUNELE9BQU8sRUFBRSxLQUFLLEVBQ2QsTUFBTSxFQUFFLGVBQWUsRUFBRyx5R0FBeUc7SUFDbkksVUFBVSxHQUFHO1FBQ1QsTUFBTSxFQUFFLElBQUk7S0FDZixDQUNKLENBQUE7SUFFRCxNQUFNLGVBQWUsR0FBRyxJQUFJLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsdUJBQXVCLEVBQUU7UUFDekYsTUFBTSxFQUFFLGVBQWUsQ0FBQyx1QkFBdUIsQ0FBQyxZQUFZLENBQ3hELFNBQVMsRUFBRSxlQUFlLENBQUMsdUJBQXVCLENBQUMsWUFBWSxDQUNsRTtRQUNELFFBQVEsRUFBRSxzQkFBc0I7UUFDaEMsUUFBUSxFQUFFLHNCQUFzQjtLQUNuQyxDQUNBLENBQUE7SUFFRCxNQUFNLGNBQWMsR0FBRyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsZUFBZSxDQUFDLENBQUE7SUFDeEUsT0FBTyxjQUFjLENBQUE7QUFDekIsQ0FBQztBQVVELE1BQWEsZUFBZ0IsU0FBUSxzQkFBUztJQUUxQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQTJCO1FBQ2pFLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxLQUFLLEdBQUcsbUJBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFNUIsNEJBQTRCO1FB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REFBOEQ7UUFDOUQsMERBQTBEO0lBQzlELENBQUM7Q0FDSjtBQXJGRCwwQ0FxRkMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IFJlbW92YWxQb2xpY3ksIFN0YWNrIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0ICogYXMgY29nbml0byBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY29nbml0byc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBydW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLXJ1bSc7XG5pbXBvcnQgKiBhcyBjdXN0b21SZXNvdXJjZXMgZnJvbSAnYXdzLWNkay1saWIvY3VzdG9tLXJlc291cmNlcyc7XG5cblxuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5cbmZ1bmN0aW9uIGN3cnVtQ3VzdG9tUmVzb3VyY2UobmFtZTogc3RyaW5nKSB7XG5cbiAgICBjb25zdCBvbl9jcmVhdGVfYXdzX3Nka19jYWxsID0gbmV3IGN1c3RvbVJlc291cmNlcy5Bd3NTZGtDYWxsKFxuICAgICAgICBwaHlzaWNhbF9yZXNvdXJjZV9pZCA9IGN1c3RvbVJlc291cmNlcy5QaHlzaWNhbFJlc291cmNlSWQuZnJvbVJlc3BvbnNlKFxuICAgICAgICAgICAgXCJBcHBNb25pdG9yLklkXCJcbiAgICAgICAgKSxcbiAgICAgICAgc2VydmljZTogXCJSVU1cIixcbiAgICAgICAgYWN0aW9uOiBcImdldEFwcE1vbml0b3JcIiwgIC8vIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9BV1NKYXZhU2NyaXB0U0RLL2xhdGVzdC9BV1MvUlVNLmh0bWwvL2dldEFwcE1vbml0b3ItcHJvcGVydHkgLy8gbm9xYTogRTUwMVxuICAgICAgICBwYXJhbWV0ZXJzID0ge1xuICAgICAgICAgICAgXCJOYW1lXCI6IG5hbWUsXG4gICAgICAgIH0sXG4gICAgKVxuXG4gICAgY29uc3QgY3VzdG9tX3Jlc291cmNlID0gbmV3IGN1c3RvbVJlc291cmNlcy5Bd3NDdXN0b21SZXNvdXJjZSh0aGlzLCBcIkN3UnVtX2N1c3RvbV9yZXNvdXJjZVwiLCB7XG4gICAgICAgIHBvbGljeTogY3VzdG9tUmVzb3VyY2VzLkF3c0N1c3RvbVJlc291cmNlUG9saWN5LmZyb21TZGtDYWxscyhcbiAgICAgICAgICAgIHJlc291cmNlczogY3VzdG9tUmVzb3VyY2VzLkF3c0N1c3RvbVJlc291cmNlUG9saWN5LkFOWV9SRVNPVVJDRVxuICAgICAgICApLFxuICAgICAgICBvbkNyZWF0ZTogb25fY3JlYXRlX2F3c19zZGtfY2FsbCxcbiAgICAgICAgb25VcGRhdGU6IG9uX2NyZWF0ZV9hd3Nfc2RrX2NhbGwsXG4gICAgfVxuICAgIClcblxuICAgIGNvbnN0IGFwcF9tb25pdG9yX2lkID0gY3VzdG9tX3Jlc291cmNlLmdldFJlc3BvbnNlRmllbGQoXCJBcHBNb25pdG9yLklkXCIpXG4gICAgcmV0dXJuIGFwcF9tb25pdG9yX2lkXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3dSdW1BcHBNb25pdG9yUHJvcHMge1xuICAgIGRvbWFpbk5hbWU6IHN0cmluZyxcbiAgICBhbGxvd0Nvb2tpZXM/OiBib29sZWFuID0gdHJ1ZSxcbiAgICBlbmFibGVYcmF5PzogYm9vbGVhbiA9IHRydWUsXG4gICAgc2Vzc2lvblNhbXBsZVJhdGU/OiAgbnVtYmVyID0gMSwgLy8gVE9ETyB3YXMgZWFsaWVyIGRlY2ltYWwgPSAxLFxuICAgIHRlbGVtZXRyaWVzPzogc3RyaW5nW10gPSBbXCJwZXJmb3JtYW5jZVwiLCBcImVycm9yc1wiLCBcImh0dHBcIl0sXG59XG5cbmV4cG9ydCBjbGFzcyBDd1J1bUFwcE1vbml0b3IgZXh0ZW5kcyBDb25zdHJ1Y3Qge1xuXG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEN3UnVtQXBwTW9uaXRvclByb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAgICAgY29uc3Qgc3RhY2sgPSBTdGFjay5vZih0aGlzKVxuXG4gICAgICAgIC8vIFJVTSBDb2duaXRvIElkZW50aXR5IFBvb2xcbiAgICAgICAgY29uc3QgcnVtX2lkZW50aXR5X3Bvb2wgPSBuZXcgY29nbml0by5DZm5JZGVudGl0eVBvb2wodGhpcywgXCJDd1J1bUlkZW50aXR5UG9vbFwiLCB7XG4gICAgICAgICAgICBhbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXM6IHRydWUsXG4gICAgICAgICAgICBhbGxvd0NsYXNzaWNGbG93OiB0cnVlXG4gICAgICAgIH1cbiAgICAgICAgKVxuXG4gICAgICAgIC8vIFJVTSBDb2duaXRvIElkZW50aXR5IFBvb2wgVW5hdXRoZW5pdGNhdGVkIFJvbGVcbiAgICAgICAgY29uc3QgcnVtX2lkX3Bvb2xfdW5hdXRoX3VzZXJfcm9sZSA9IG5ldyBpYW0uUm9sZSh0aGlzLCBcIkN3UnVtQ29nbml0b0RlZmF1bHRVbmF1dGhlbnRpY2F0ZWRSb2xlXCIsIHtcbiAgICAgICAgICAgIGFzc3VtZWRCeTogbmV3IGlhbS5GZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgICAgICAgICAgXCJjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb21cIixcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIFwiU3RyaW5nRXF1YWxzXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tOmF1ZFwiOiBydW1faWRlbnRpdHlfcG9vbC5yZWYsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIFwiRm9yQW55VmFsdWU6U3RyaW5nTGlrZVwiOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcImNvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphbXJcIjogXCJ1bmF1dGhlbnRpY2F0ZWRcIixcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIFwic3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHlcIixcbiAgICAgICAgICAgICksXG4gICAgICAgIH0pXG5cbiAgICAgICAgcnVtX2lkX3Bvb2xfdW5hdXRoX3VzZXJfcm9sZS5hcHBseVJlbW92YWxQb2xpY3koUmVtb3ZhbFBvbGljeS5ERVNUUk9ZKVxuXG4gICAgICAgIG5ldyBjb2duaXRvLkNmbklkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50KHRoaXMsIFwiQ3dSdW1JZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudFwiLCB7XG4gICAgICAgICAgICBpZGVudGl0eVBvb2xJZDogcnVtX2lkZW50aXR5X3Bvb2wucmVmLFxuICAgICAgICAgICAgcm9sZXM6IHtcbiAgICAgICAgICAgICAgICBcInVuYXV0aGVudGljYXRlZFwiOiBydW1faWRfcG9vbF91bmF1dGhfdXNlcl9yb2xlLnJvbGVBcm4sXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KVxuXG4gICAgICAgIC8vIFJVTSBBcHAgTW9uaXRvclxuICAgICAgICBjb25zdCBjZm5fYXBwX21vbml0b3IgPSBuZXcgcnVtLkNmbkFwcE1vbml0b3IodGhpcywgXCJDZm5BcHBNb25pdG9yXCIsIHtcbiAgICAgICAgICAgIGRvbWFpbjogcHJvcHMuZG9tYWluTmFtZSxcbiAgICAgICAgICAgIG5hbWU6IHByb3BzLmRvbWFpbk5hbWUsXG4gICAgICAgICAgICBhcHBNb25pdG9yQ29uZmlndXJhdGlvbjoge1xuICAgICAgICAgICAgICAgIGFsbG93Q29va2llczogcHJvcHMuYWxsb3dDb29raWVzLFxuICAgICAgICAgICAgICAgIGVuYWJsZVhSYXk6IHByb3BzLmVuYWJsZVhyYXksXG4gICAgICAgICAgICAgICAgZ3Vlc3RSb2xlQXJuOiBydW1faWRfcG9vbF91bmF1dGhfdXNlcl9yb2xlLnJvbGVBcm4sXG4gICAgICAgICAgICAgICAgaWRlbnRpdHlQb29sSWQ6IHJ1bV9pZGVudGl0eV9wb29sLnJlZixcbiAgICAgICAgICAgICAgICBzZXNzaW9uU2FtcGxlUmF0ZTogcHJvcHMuc2Vzc2lvblNhbXBsZVJhdGUsXG4gICAgICAgICAgICAgICAgdGVsZW1ldHJpZXM6IHByb3BzLnRlbGVtZXRyaWVzLFxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuXG4gICAgICAgIGNvbnN0IHJ1bV9wb2xpY3kgPSBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICBhY3Rpb25zOiBbXCJydW06UHV0UnVtRXZlbnRzXCJdLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbXG4gICAgICAgICAgICAgICAgYGFybjphd3M6cnVtOiR7c3RhY2sucmVnaW9ufToke3N0YWNrLmFjY291bnR9OmFwcG1vbml0b3IvJHtjZm5fYXBwX21vbml0b3IucmVmfWBcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0pXG5cbiAgICAgICAgcnVtX2lkX3Bvb2xfdW5hdXRoX3VzZXJfcm9sZS5hZGRUb1BvbGljeShydW1fcG9saWN5KVxuXG4gICAgICAgIGNvbnN0IHJ1bV9hcHBfbW9uaXRvcl9pZCA9IGN3cnVtQ3VzdG9tUmVzb3VyY2UoY2ZuX2FwcF9tb25pdG9yLnJlZilcblxuICAgICAgICAvLyB0aGlzLm5hbWUgPSBjZm5fYXBwX21vbml0b3IucmVmIC8vIFRPRE8gaXMgdGhpcyBleHBvcnQgbmVlZGVkP1xuICAgICAgICBjZm5fYXBwX21vbml0b3IuYXBwTW9uaXRvckNvbmZpZ3VyYXRpb24hXG5cbiAgICAgICAgLy8gVE9ETyBmaXggdGhpc1xuICAgICAgICBjb25zdCBydW1fc2NyaXB0ID0gYDxzY3JpcHQ+KGZ1bmN0aW9uKG4saSx2LHIscyxjLHgseil7e3g9d2luZG93LkF3c1J1bUNsaWVudD17e3E6W10sbjpuLGk6aSx2OnYscjpyLGM6Y319O3dpbmRvd1tuXT1mdW5jdGlvbihjLHApe3t4LnEucHVzaCh7e2M6YyxwOnB9fSk7fX07ej1kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTt6LmFzeW5jPXRydWU7ei5zcmM9cztkb2N1bWVudC5oZWFkLmluc2VydEJlZm9yZSh6LGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXSk7fX0pKCdjd3InLCcke3J1bV9hcHBfbW9uaXRvcl9pZH0nLCcxLjAuMCcsJyR7c3RhY2sucmVnaW9ufScsJ2h0dHBzOi8vY2xpZW50LnJ1bS51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS8xLjAuMi9jd3IuanMnLHt7c2Vzc2lvblNhbXBsZVJhdGU6MSxndWVzdFJvbGVBcm46XFxcIiR7cnVtX2lkX3Bvb2xfdW5hdXRoX3VzZXJfcm9sZS5yb2xlQXJufVxcXCIsaWRlbnRpdHlQb29sSWQ6XFxcIiR7cnVtX2lkZW50aXR5X3Bvb2wucmVmfVxcXCIsZW5kcG9pbnQ6XFxcImh0dHBzOi8vZGF0YXBsYW5lLnJ1bS5ldS13ZXN0LTEuYW1hem9uYXdzLmNvbVxcXCIsdGVsZW1ldHJpZXM6JHtydW1fYXBwX21vbml0b3JfY29uZmlnX3RlbGVtZXRyaWVzfSxhbGxvd0Nvb2tpZXM6JHtydW1fYXBwX21vbml0b3JfY29uZmlnX2Nvb2tpZXN9LGVuYWJsZVhSYXk6JHtydW1fYXBwX21vbml0b3JfY29uZmlnX3hfcmF5fX19KTs8L3NjcmlwdD5gXG4gICAgICAgICAgICBydW1fYXBwX21vbml0b3JfY29uZmlnX3hfcmF5ID0gc3RyKFxuICAgICAgICAgICAgICAgIGNmbl9hcHBfbW9uaXRvci5hcHBfbW9uaXRvcl9jb25maWd1cmF0aW9uLmVuYWJsZV94X3JheVxuICAgICAgICAgICAgKS5sb3dlcigpLFxuICAgICAgICAgICAgcnVtX2FwcF9tb25pdG9yX2NvbmZpZ19jb29raWVzID0gc3RyKFxuICAgICAgICAgICAgICAgIGNmbl9hcHBfbW9uaXRvci5hcHBfbW9uaXRvcl9jb25maWd1cmF0aW9uLmFsbG93X2Nvb2tpZXNcbiAgICAgICAgICAgICkubG93ZXIoKSxcbiAgICAgICAgICAgIHJ1bV9hcHBfbW9uaXRvcl9jb25maWdfdGVsZW1ldHJpZXMgPSBzdHIoXG4gICAgICAgICAgICAgICAgY2ZuX2FwcF9tb25pdG9yLmFwcF9tb25pdG9yX2NvbmZpZ3VyYXRpb24udGVsZW1ldHJpZXNcbiAgICAgICAgICAgICksXG4gICAgICAgIClcblxuICAgICAgICAvLyB0aGlzLm5hbWUgPSBjZm5fYXBwX21vbml0b3IucmVmIC8vIFRPRE8gaXMgdGhpcyBleHBvcnQgbmVlZGVkP1xuICAgICAgICAvLyB0aGlzLmlkID0gcnVtX2FwcF9tb25pdG9yX2lkIC8vIFRPRE8gaXMgdGhpcyBleHBvcnQgbmVlZGVkP1xuICAgICAgICAvLyB0aGlzLnNjcmlwdCA9IHJ1bV9zY3JpcHQgLy8gVE9ETyBpcyB0aGlzIGV4cG9ydCBuZWVkZWQ/XG4gICAgfVxufSJdfQ==