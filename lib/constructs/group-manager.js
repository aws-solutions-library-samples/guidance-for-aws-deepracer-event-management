'use strict';
Object.defineProperty(exports, '__esModule', { value: true });
exports.GroupManager = void 0;
const lambdaPython = require('@aws-cdk/aws-lambda-python-alpha');
const aws_cdk_lib_1 = require('aws-cdk-lib');
const apig = require('aws-cdk-lib/aws-apigateway');
const iam = require('aws-cdk-lib/aws-iam');
const lambda = require('aws-cdk-lib/aws-lambda');
const constructs_1 = require('constructs');
class GroupManager extends constructs_1.Construct {
  // public readonly origin: cloudfront.IOrigin;
  // public readonly sourceBucket: s3.IBucket;
  constructor(scope, id, props) {
    super(scope, id);
    // GET groups users Function
    const get_groups_group_function = new lambdaPython.PythonFunction(
      this,
      'get_groups_group_function',
      {
        entry: 'lib/lambdas/get_groups_group_function/',
        description: 'Get the group details from cognito',
        index: 'index.py',
        handler: 'lambda_handler',
        timeout: aws_cdk_lib_1.Duration.minutes(1),
        runtime: props.lambdaConfig.runtime,
        tracing: lambda.Tracing.ACTIVE,
        memorySize: 128,
        architecture: props.lambdaConfig.architecture,
        environment: {
          user_pool_id: props.userPoolId,
          POWERTOOLS_SERVICE_NAME: 'get_groups_group',
          LOG_LEVEL: props.lambdaConfig.layersConfig.powerToolsLogLevel,
        },
        bundling: {
          image: props.lambdaConfig.bundlingImage,
        },
      }
    );
    get_groups_group_function.addToRolePolicy(
      new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: ['cognito-idp:ListUsersInGroup'],
        resources: [props.userPoolArn],
      })
    );
    // Post groups group user Function
    const postGroupsGroupUserFunction = new lambdaPython.PythonFunction(
      this,
      'postGroupsGroupUserFunction',
      {
        entry: 'lib/lambdas/postGroupsGroupUserFunction/',
        description: 'Add a user to a group in cognito',
        index: 'index.py',
        handler: 'lambda_handler',
        timeout: aws_cdk_lib_1.Duration.minutes(1),
        runtime: props.lambdaConfig.runtime,
        tracing: lambda.Tracing.ACTIVE,
        memorySize: 128,
        architecture: props.lambdaConfig.architecture,
        environment: {
          user_pool_id: props.userPoolId,
          POWERTOOLS_SERVICE_NAME: 'post_groups_group_user',
          LOG_LEVEL: props.lambdaConfig.layersConfig.powerToolsLogLevel,
        },
        bundling: {
          image: props.lambdaConfig.bundlingImage,
        },
      }
    );
    postGroupsGroupUserFunction.addToRolePolicy(
      new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: ['cognito-idp:AdminAddUserToGroup'],
        resources: [props.userPoolArn],
      })
    );
    // Delete groups group user Function
    const deleteGroupsGroupUserFunction = new lambdaPython.PythonFunction(
      this,
      'deleteGroupsGroupUserFunction',
      {
        entry: 'lib/lambdas/deleteGroupsGroupUserFunction/',
        description: 'Remove a user from a group in cognito',
        index: 'index.py',
        handler: 'lambda_handler',
        timeout: aws_cdk_lib_1.Duration.minutes(1),
        runtime: props.lambdaConfig.runtime,
        tracing: lambda.Tracing.ACTIVE,
        memorySize: 128,
        architecture: props.lambdaConfig.architecture,
        environment: {
          user_pool_id: props.userPoolId,
          POWERTOOLS_SERVICE_NAME: 'delete_groups_group_user',
          LOG_LEVEL: props.lambdaConfig.layersConfig.powerToolsLogLevel,
        },
        bundling: {
          image: props.lambdaConfig.bundlingImage,
        },
      }
    );
    deleteGroupsGroupUserFunction.addToRolePolicy(
      new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: ['cognito-idp:AdminRemoveUserFromGroup'],
        resources: [props.userPoolArn],
      })
    );
    // Get groups Function
    const get_groups_function = new lambdaPython.PythonFunction(this, 'get_groups_function', {
      entry: 'lib/lambdas/get_groups_function/',
      description: 'List the groups in cognito',
      index: 'index.py',
      handler: 'lambda_handler',
      timeout: aws_cdk_lib_1.Duration.minutes(1),
      runtime: props.lambdaConfig.runtime,
      tracing: lambda.Tracing.ACTIVE,
      memorySize: 128,
      architecture: props.lambdaConfig.architecture,
      environment: {
        user_pool_id: props.userPoolId,
        POWERTOOLS_SERVICE_NAME: 'get_groups',
        LOG_LEVEL: props.lambdaConfig.layersConfig.powerToolsLogLevel,
      },
      bundling: {
        image: props.lambdaConfig.bundlingImage,
      },
    });
    get_groups_function.addToRolePolicy(
      new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: ['cognito-idp:ListGroups'],
        resources: [props.userPoolArn],
      })
    );
    // Put groups group Function
    const put_groups_group_function = new lambdaPython.PythonFunction(
      this,
      'put_groups_group_function',
      {
        entry: 'lib/lambdas/put_groups_group_function/',
        description: 'Add a group to cognito',
        index: 'index.py',
        handler: 'lambda_handler',
        timeout: aws_cdk_lib_1.Duration.minutes(1),
        runtime: props.lambdaConfig.runtime,
        tracing: lambda.Tracing.ACTIVE,
        memorySize: 128,
        architecture: props.lambdaConfig.architecture,
        environment: {
          user_pool_id: props.userPoolId,
          POWERTOOLS_SERVICE_NAME: 'put_groups_group',
          LOG_LEVEL: props.lambdaConfig.layersConfig.powerToolsLogLevel,
        },
        bundling: {
          image: props.lambdaConfig.bundlingImage,
        },
      }
    );
    put_groups_group_function.addToRolePolicy(
      new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: ['cognito-idp:CreateGroup'],
        resources: [props.userPoolArn],
      })
    );
    // Delete groups group Function
    const delete_groups_group_function = new lambdaPython.PythonFunction(
      this,
      'delete_groups_group_function',
      {
        entry: 'lib/lambdas/delete_groups_group_function/',
        description: 'Delete a group from cognito',
        index: 'index.py',
        handler: 'lambda_handler',
        timeout: aws_cdk_lib_1.Duration.minutes(1),
        runtime: props.lambdaConfig.runtime,
        tracing: lambda.Tracing.ACTIVE,
        memorySize: 128,
        architecture: props.lambdaConfig.architecture,
        environment: {
          user_pool_id: props.userPoolId,
          POWERTOOLS_SERVICE_NAME: 'delete_groups_group',
          LOG_LEVEL: props.lambdaConfig.layersConfig.powerToolsLogLevel,
        },
        bundling: {
          image: props.lambdaConfig.bundlingImage,
        },
      }
    );
    delete_groups_group_function.addToRolePolicy(
      new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        actions: ['cognito-idp:DeleteGroup'],
        resources: [props.userPoolArn],
      })
    );
    // API RESOURCES
    const username_groupname_model = props.restApi.api.addModel('UsernameGroupnameModel', {
      contentType: 'application/json',
      schema: {
        schema: apig.JsonSchemaVersion.DRAFT4,
        type: apig.JsonSchemaType.OBJECT,
        properties: {
          username: { type: apig.JsonSchemaType.STRING },
          groupname: { type: apig.JsonSchemaType.STRING },
        },
      },
    });
    // GET /admin/groups
    const apiAdminGroups = props.restApi.apiAdminResource.addResource('groups');
    apiAdminGroups.addMethod('GET', new apig.LambdaIntegration(get_groups_function), {
      authorizationType: apig.AuthorizationType.IAM,
    });
    // PUT /admin/groups
    apiAdminGroups.addMethod('PUT', new apig.LambdaIntegration(put_groups_group_function), {
      authorizationType: apig.AuthorizationType.IAM,
    });
    // /admin/groups/{groupname}
    const group = apiAdminGroups.addResource('{groupname}');
    // GET /admin/groups/{groupname}
    group.addMethod('GET', new apig.LambdaIntegration(get_groups_group_function), {
      authorizationType: apig.AuthorizationType.IAM,
    });
    // DELETE /admin/groups/{groupname}
    group.addMethod('DELETE', new apig.LambdaIntegration(delete_groups_group_function), {
      authorizationType: apig.AuthorizationType.IAM,
    });
    // POST /admin/groups/{groupname}
    group.addMethod('POST', new apig.LambdaIntegration(postGroupsGroupUserFunction), {
      authorizationType: apig.AuthorizationType.IAM,
      requestModels: { 'application/json': username_groupname_model },
      requestValidator: props.restApi.bodyValidator,
    });
    // /admin/groups/{groupname}/{username}
    const group_user = group.addResource('{username}');
    // DELETE /admin/groups/{groupname}/{username}
    group_user.addMethod('DELETE', new apig.LambdaIntegration(deleteGroupsGroupUserFunction), {
      authorizationType: apig.AuthorizationType.IAM,
    });
  }
}
exports.GroupManager = GroupManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JvdXAtbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdyb3VwLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsaUVBQWlFO0FBQ2pFLDZDQUFvRDtBQUNwRCxtREFBbUQ7QUFFbkQsMkNBQTJDO0FBRTNDLGlEQUFpRDtBQUlqRCwyQ0FBdUM7QUEwQnZDLE1BQWEsWUFBYSxTQUFRLHNCQUFTO0lBQ3ZDLDhDQUE4QztJQUM5Qyw0Q0FBNEM7SUFFNUMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF3QjtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLDRCQUE0QjtRQUM1QixNQUFNLHlCQUF5QixHQUFHLElBQUksWUFBWSxDQUFDLGNBQWMsQ0FDN0QsSUFBSSxFQUNKLDJCQUEyQixFQUFFO1lBQzdCLEtBQUssRUFBRSx3Q0FBd0M7WUFDL0MsV0FBVyxFQUFFLG9DQUFvQztZQUNqRCxLQUFLLEVBQUUsVUFBVTtZQUNqQixPQUFPLEVBQUUsZ0JBQWdCO1lBQ3pCLE9BQU8sRUFBRSxzQkFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDNUIsT0FBTyxFQUFFLEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBTztZQUNuQyxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNO1lBQzlCLFVBQVUsRUFBRSxHQUFHO1lBQ2YsWUFBWSxFQUFFLEtBQUssQ0FBQyxZQUFZLENBQUMsWUFBWTtZQUM3QyxXQUFXLEVBQUU7Z0JBQ1QsY0FBYyxFQUFFLEtBQUssQ0FBQyxVQUFVO2dCQUNoQyx5QkFBeUIsRUFBRSxrQkFBa0I7Z0JBQzdDLFdBQVcsRUFBRSxLQUFLLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxrQkFBa0I7YUFDbEU7WUFDRCxRQUFRLEVBQUU7Z0JBQ04sS0FBSyxFQUFFLEtBQUssQ0FBQyxZQUFZLENBQUMsYUFBYTthQUMxQztTQUVKLENBQUMsQ0FBQTtRQUNG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LE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUE7UUFFbEQsOENBQThDO1FBQzlDLFVBQVUsQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUN6QixJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyw2QkFBNkIsQ0FBQyxFQUFFO1lBQzNELGlCQUFpQixFQUFFLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHO1NBQ2hELENBQUMsQ0FBQTtJQUNOLENBQUM7Q0FDSjtBQTFRRCxvQ0EwUUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCAqIGFzIGxhbWJkYVB5dGhvbiBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhLXB5dGhvbi1hbHBoYSc7XG5pbXBvcnQgeyBEb2NrZXJJbWFnZSwgRHVyYXRpb24gfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBhcGlnIGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5JztcbmltcG9ydCAqIGFzIGFwcHN5bmMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwcHN5bmMnO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHsgSVJvbGUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCB7IENvZGVGaXJzdFNjaGVtYSB9IGZyb20gJ2F3c2Nkay1hcHBzeW5jLXV0aWxzJztcblxuXG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcblxuZXhwb3J0IGludGVyZmFjZSBHcm91cE1hbmFnZXJQcm9wcyB7XG4gICAgYWRtaW5Hcm91cFJvbGU6IElSb2xlLFxuICAgIHVzZXJQb29sSWQ6IHN0cmluZyxcbiAgICB1c2VyUG9vbEFybjogc3RyaW5nLFxuICAgIGFwcHN5bmNBcGk6IHtcbiAgICAgICAgc2NoZW1hOiBDb2RlRmlyc3RTY2hlbWEsXG4gICAgICAgIGFwaTogYXBwc3luYy5JR3JhcGhxbEFwaVxuICAgIH0sXG4gICAgcmVzdEFwaToge1xuICAgICAgICBhcGk6IGFwaWcuUmVzdEFwaSxcbiAgICAgICAgYXBpQWRtaW5SZXNvdXJjZTogYXBpZy5SZXNvdXJjZVxuICAgICAgICBib2R5VmFsaWRhdG9yOiBhcGlnLlJlcXVlc3RWYWxpZGF0b3JcbiAgICB9LFxuICAgIGxhbWJkYUNvbmZpZzoge1xuICAgICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZSxcbiAgICAgICAgYXJjaGl0ZWN0dXJlOiBsYW1iZGEuQXJjaGl0ZWN0dXJlLFxuICAgICAgICBidW5kbGluZ0ltYWdlOiBEb2NrZXJJbWFnZVxuICAgICAgICBsYXllcnNDb25maWc6IHtcbiAgICAgICAgICAgIHBvd2VyVG9vbHNMb2dMZXZlbDogc3RyaW5nXG4gICAgICAgIH1cbiAgICB9XG5cbn1cblxuZXhwb3J0IGNsYXNzIEdyb3VwTWFuYWdlciBleHRlbmRzIENvbnN0cnVjdCB7XG4gICAgLy8gcHVibGljIHJlYWRvbmx5IG9yaWdpbjogY2xvdWRmcm9udC5JT3JpZ2luO1xuICAgIC8vIHB1YmxpYyByZWFkb25seSBzb3VyY2VCdWNrZXQ6IHMzLklCdWNrZXQ7XG5cbiAgICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogR3JvdXBNYW5hZ2VyUHJvcHMpIHtcbiAgICAgICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgICAgICAvLyBHRVQgZ3JvdXBzIHVzZXJzIEZ1bmN0aW9uXG4gICAgICAgIGNvbnN0IGdldF9ncm91cHNfZ3JvdXBfZnVuY3Rpb24gPSBuZXcgbGFtYmRhUHl0aG9uLlB5dGhvbkZ1bmN0aW9uKFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgIFwiZ2V0X2dyb3Vwc19ncm91cF9mdW5jdGlvblwiLCB7XG4gICAgICAgICAgICBlbnRyeTogXCJsaWIvbGFtYmRhcy9nZXRfZ3JvdXBzX2dyb3VwX2Z1bmN0aW9uL1wiLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiR2V0IHRoZSBncm91cCBkZXRhaWxzIGZyb20gY29nbml0b1wiLFxuICAgICAgICAgICAgaW5kZXg6IFwiaW5kZXgucHlcIixcbiAgICAgICAgICAgIGhhbmRsZXI6IFwibGFtYmRhX2hhbmRsZXJcIixcbiAgICAgICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoMSksXG4gICAgICAgICAgICBydW50aW1lOiBwcm9wcy5sYW1iZGFDb25maWcucnVudGltZSxcbiAgICAgICAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgICAgICAgIG1lbW9yeVNpemU6IDEyOCxcbiAgICAgICAgICAgIGFyY2hpdGVjdHVyZTogcHJvcHMubGFtYmRhQ29uZmlnLmFyY2hpdGVjdHVyZSxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgXCJ1c2VyX3Bvb2xfaWRcIjogcHJvcHMudXNlclBvb2xJZCxcbiAgICAgICAgICAgICAgICBcIlBPV0VSVE9PTFNfU0VSVklDRV9OQU1FXCI6IFwiZ2V0X2dyb3Vwc19ncm91cFwiLFxuICAgICAgICAgICAgICAgIFwiTE9HX0xFVkVMXCI6IHByb3BzLmxhbWJkYUNvbmZpZy5sYXllcnNDb25maWcucG93ZXJUb29sc0xvZ0xldmVsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgICAgICAgICAgaW1hZ2U6IHByb3BzLmxhbWJkYUNvbmZpZy5idW5kbGluZ0ltYWdlXG4gICAgICAgICAgICB9LFxuLy8gICAgICAgICAgICBsYXllcnM6IFtiYXNlX3N0YWNrLl9oZWxwZXJfZnVuY3Rpb25zX2xheWVyLCBiYXNlX3N0YWNrLl9wb3dlcnRvb2xzX2xheWVyXSwgICAgLy8gVE9ETyB1bmNvbW1lbnQgd2hlbiBmaXhlZCBpbiBiYXNlIHN0YWNrXG4gICAgICAgIH0pXG4gICAgICAgIGdldF9ncm91cHNfZ3JvdXBfZnVuY3Rpb24uYWRkVG9Sb2xlUG9saWN5KFxuICAgICAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICAgICAgIFwiY29nbml0by1pZHA6TGlzdFVzZXJzSW5Hcm91cFwiLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMudXNlclBvb2xBcm5dLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuXG4gICAgICAgIC8vIFBvc3QgZ3JvdXBzIGdyb3VwIHVzZXIgRnVuY3Rpb25cbiAgICAgICAgY29uc3QgcG9zdEdyb3Vwc0dyb3VwVXNlckZ1bmN0aW9uID0gbmV3IGxhbWJkYVB5dGhvbi5QeXRob25GdW5jdGlvbihcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICBcInBvc3RHcm91cHNHcm91cFVzZXJGdW5jdGlvblwiLCB7XG4gICAgICAgICAgICBlbnRyeTogXCJsaWIvbGFtYmRhcy9wb3N0R3JvdXBzR3JvdXBVc2VyRnVuY3Rpb24vXCIsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogXCJBZGQgYSB1c2VyIHRvIGEgZ3JvdXAgaW4gY29nbml0b1wiLFxuICAgICAgICAgICAgaW5kZXg6IFwiaW5kZXgucHlcIixcbiAgICAgICAgICAgIGhhbmRsZXI6IFwibGFtYmRhX2hhbmRsZXJcIixcbiAgICAgICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoMSksXG4gICAgICAgICAgICBydW50aW1lOiBwcm9wcy5sYW1iZGFDb25maWcucnVudGltZSxcbiAgICAgICAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgICAgICAgIG1lbW9yeVNpemU6IDEyOCxcbiAgICAgICAgICAgIGFyY2hpdGVjdHVyZTogcHJvcHMubGFtYmRhQ29uZmlnLmFyY2hpdGVjdHVyZSxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgXCJ1c2VyX3Bvb2xfaWRcIjogcHJvcHMudXNlclBvb2xJZCxcbiAgICAgICAgICAgICAgICBcIlBPV0VSVE9PTFNfU0VSVklDRV9OQU1FXCI6IFwicG9zdF9ncm91cHNfZ3JvdXBfdXNlclwiLFxuICAgICAgICAgICAgICAgIFwiTE9HX0xFVkVMXCI6IHByb3BzLmxhbWJkYUNvbmZpZy5sYXllcnNDb25maWcucG93ZXJUb29sc0xvZ0xldmVsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgICAgICAgICAgaW1hZ2U6IHByb3BzLmxhbWJkYUNvbmZpZy5idW5kbGluZ0ltYWdlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gbGF5ZXJzOiBbYmFzZV9zdGFjay5faGVscGVyX2Z1bmN0aW9uc19sYXllciwgYmFzZV9zdGFjay5fcG93ZXJ0b29sc19sYXllcl0sICAgICAvLyBUT0RPIHVuY29tbWVudCB3aGVuIGZpeGVkIGluIGJhc2Ugc3RhY2tcbiAgICAgICAgfSlcbiAgICAgICAgcG9zdEdyb3Vwc0dyb3VwVXNlckZ1bmN0aW9uLmFkZFRvUm9sZVBvbGljeShcbiAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICBcImNvZ25pdG8taWRwOkFkbWluQWRkVXNlclRvR3JvdXBcIixcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogW3Byb3BzLnVzZXJQb29sQXJuXSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgIClcblxuICAgICAgICAvLyBEZWxldGUgZ3JvdXBzIGdyb3VwIHVzZXIgRnVuY3Rpb25cbiAgICAgICAgY29uc3QgZGVsZXRlR3JvdXBzR3JvdXBVc2VyRnVuY3Rpb24gPSBuZXcgbGFtYmRhUHl0aG9uLlB5dGhvbkZ1bmN0aW9uKFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgIFwiZGVsZXRlR3JvdXBzR3JvdXBVc2VyRnVuY3Rpb25cIiwge1xuICAgICAgICAgICAgZW50cnk6IFwibGliL2xhbWJkYXMvZGVsZXRlR3JvdXBzR3JvdXBVc2VyRnVuY3Rpb24vXCIsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogXCJSZW1vdmUgYSB1c2VyIGZyb20gYSBncm91cCBpbiBjb2duaXRvXCIsXG4gICAgICAgICAgICBpbmRleDogXCJpbmRleC5weVwiLFxuICAgICAgICAgICAgaGFuZGxlcjogXCJsYW1iZGFfaGFuZGxlclwiLFxuICAgICAgICAgICAgdGltZW91dDogRHVyYXRpb24ubWludXRlcygxKSxcbiAgICAgICAgICAgIHJ1bnRpbWU6IHByb3BzLmxhbWJkYUNvbmZpZy5ydW50aW1lLFxuICAgICAgICAgICAgdHJhY2luZzogbGFtYmRhLlRyYWNpbmcuQUNUSVZFLFxuICAgICAgICAgICAgbWVtb3J5U2l6ZTogMTI4LFxuICAgICAgICAgICAgYXJjaGl0ZWN0dXJlOiBwcm9wcy5sYW1iZGFDb25maWcuYXJjaGl0ZWN0dXJlLFxuICAgICAgICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgICAgICAgICBcInVzZXJfcG9vbF9pZFwiOiBwcm9wcy51c2VyUG9vbElkLFxuICAgICAgICAgICAgICAgIFwiUE9XRVJUT09MU19TRVJWSUNFX05BTUVcIjogXCJkZWxldGVfZ3JvdXBzX2dyb3VwX3VzZXJcIixcbiAgICAgICAgICAgICAgICBcIkxPR19MRVZFTFwiOiBwcm9wcy5sYW1iZGFDb25maWcubGF5ZXJzQ29uZmlnLnBvd2VyVG9vbHNMb2dMZXZlbCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBidW5kbGluZzoge1xuICAgICAgICAgICAgICAgIGltYWdlOiBwcm9wcy5sYW1iZGFDb25maWcuYnVuZGxpbmdJbWFnZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC8vIGxheWVyczogW2Jhc2Vfc3RhY2suX2hlbHBlcl9mdW5jdGlvbnNfbGF5ZXIsIGJhc2Vfc3RhY2suX3Bvd2VydG9vbHNfbGF5ZXJdLCAgICAgLy8gVE9ETyB1bmNvbW1lbnQgd2hlbiBmaXhlZCBpbiBiYXNlIHN0YWNrXG4gICAgICAgIH0pXG4gICAgICAgIGRlbGV0ZUdyb3Vwc0dyb3VwVXNlckZ1bmN0aW9uLmFkZFRvUm9sZVBvbGljeShcbiAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICBcImNvZ25pdG8taWRwOkFkbWluUmVtb3ZlVXNlckZyb21Hcm91cFwiLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMudXNlclBvb2xBcm5dLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuXG4gICAgICAgIC8vIEdldCBncm91cHMgRnVuY3Rpb25cbiAgICAgICAgY29uc3QgZ2V0X2dyb3Vwc19mdW5jdGlvbiA9IG5ldyBsYW1iZGFQeXRob24uUHl0aG9uRnVuY3Rpb24oXG4gICAgICAgICAgICB0aGlzLFxuICAgICAgICAgICAgXCJnZXRfZ3JvdXBzX2Z1bmN0aW9uXCIsIHtcbiAgICAgICAgICAgIGVudHJ5OiBcImxpYi9sYW1iZGFzL2dldF9ncm91cHNfZnVuY3Rpb24vXCIsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogXCJMaXN0IHRoZSBncm91cHMgaW4gY29nbml0b1wiLFxuICAgICAgICAgICAgaW5kZXg6IFwiaW5kZXgucHlcIixcbiAgICAgICAgICAgIGhhbmRsZXI6IFwibGFtYmRhX2hhbmRsZXJcIixcbiAgICAgICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoMSksXG4gICAgICAgICAgICBydW50aW1lOiBwcm9wcy5sYW1iZGFDb25maWcucnVudGltZSxcbiAgICAgICAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgICAgICAgIG1lbW9yeVNpemU6IDEyOCxcbiAgICAgICAgICAgIGFyY2hpdGVjdHVyZTogcHJvcHMubGFtYmRhQ29uZmlnLmFyY2hpdGVjdHVyZSxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgXCJ1c2VyX3Bvb2xfaWRcIjogcHJvcHMudXNlclBvb2xJZCxcbiAgICAgICAgICAgICAgICBcIlBPV0VSVE9PTFNfU0VSVklDRV9OQU1FXCI6IFwiZ2V0X2dyb3Vwc1wiLFxuICAgICAgICAgICAgICAgIFwiTE9HX0xFVkVMXCI6IHByb3BzLmxhbWJkYUNvbmZpZy5sYXllcnNDb25maWcucG93ZXJUb29sc0xvZ0xldmVsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgICAgICAgICAgaW1hZ2U6IHByb3BzLmxhbWJkYUNvbmZpZy5idW5kbGluZ0ltYWdlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gbGF5ZXJzOiBbYmFzZV9zdGFjay5faGVscGVyX2Z1bmN0aW9uc19sYXllciwgYmFzZV9zdGFjay5fcG93ZXJ0b29sc19sYXllcl0sICAgICAvLyBUT0RPIHVuY29tbWVudCB3aGVuIGZpeGVkIGluIGJhc2Ugc3RhY2tcbiAgICAgICAgfSlcblxuICAgICAgICBnZXRfZ3JvdXBzX2Z1bmN0aW9uLmFkZFRvUm9sZVBvbGljeShcbiAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICBcImNvZ25pdG8taWRwOkxpc3RHcm91cHNcIixcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIHJlc291cmNlczogW3Byb3BzLnVzZXJQb29sQXJuXSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgIClcblxuICAgICAgICAvLyBQdXQgZ3JvdXBzIGdyb3VwIEZ1bmN0aW9uXG4gICAgICAgIGNvbnN0IHB1dF9ncm91cHNfZ3JvdXBfZnVuY3Rpb24gPSBuZXcgbGFtYmRhUHl0aG9uLlB5dGhvbkZ1bmN0aW9uKFxuICAgICAgICAgICAgdGhpcyxcbiAgICAgICAgICAgIFwicHV0X2dyb3Vwc19ncm91cF9mdW5jdGlvblwiLCB7XG4gICAgICAgICAgICBlbnRyeTogXCJsaWIvbGFtYmRhcy9wdXRfZ3JvdXBzX2dyb3VwX2Z1bmN0aW9uL1wiLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiQWRkIGEgZ3JvdXAgdG8gY29nbml0b1wiLFxuICAgICAgICAgICAgaW5kZXg6IFwiaW5kZXgucHlcIixcbiAgICAgICAgICAgIGhhbmRsZXI6IFwibGFtYmRhX2hhbmRsZXJcIixcbiAgICAgICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoMSksXG4gICAgICAgICAgICBydW50aW1lOiBwcm9wcy5sYW1iZGFDb25maWcucnVudGltZSxcbiAgICAgICAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgICAgICAgIG1lbW9yeVNpemU6IDEyOCxcbiAgICAgICAgICAgIGFyY2hpdGVjdHVyZTogcHJvcHMubGFtYmRhQ29uZmlnLmFyY2hpdGVjdHVyZSxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgXCJ1c2VyX3Bvb2xfaWRcIjogcHJvcHMudXNlclBvb2xJZCxcbiAgICAgICAgICAgICAgICBcIlBPV0VSVE9PTFNfU0VSVklDRV9OQU1FXCI6IFwicHV0X2dyb3Vwc19ncm91cFwiLFxuICAgICAgICAgICAgICAgIFwiTE9HX0xFVkVMXCI6IHByb3BzLmxhbWJkYUNvbmZpZy5sYXllcnNDb25maWcucG93ZXJUb29sc0xvZ0xldmVsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgICAgICAgICAgaW1hZ2U6IHByb3BzLmxhbWJkYUNvbmZpZy5idW5kbGluZ0ltYWdlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gbGF5ZXJzOiBbYmFzZV9zdGFjay5faGVscGVyX2Z1bmN0aW9uc19sYXllciwgYmFzZV9zdGFjay5fcG93ZXJ0b29sc19sYXllcl0sICAgICAvLyBUT0RPIHVuY29tbWVudCB3aGVuIGZpeGVkIGluIGJhc2Ugc3RhY2tcbiAgICAgICAgfSlcblxuICAgICAgICBwdXRfZ3JvdXBzX2dyb3VwX2Z1bmN0aW9uLmFkZFRvUm9sZVBvbGljeShcbiAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgICAgICAgICAgICBcImNvZ25pdG8taWRwOkNyZWF0ZUdyb3VwXCIsXG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICByZXNvdXJjZXM6IFtwcm9wcy51c2VyUG9vbEFybl0sXG4gICAgICAgICAgICB9KVxuICAgICAgICApXG5cbiAgICAgICAgLy8gRGVsZXRlIGdyb3VwcyBncm91cCBGdW5jdGlvblxuICAgICAgICBjb25zdCBkZWxldGVfZ3JvdXBzX2dyb3VwX2Z1bmN0aW9uID0gbmV3IGxhbWJkYVB5dGhvbi5QeXRob25GdW5jdGlvbihcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICBcImRlbGV0ZV9ncm91cHNfZ3JvdXBfZnVuY3Rpb25cIiwge1xuICAgICAgICAgICAgZW50cnk6IFwibGliL2xhbWJkYXMvZGVsZXRlX2dyb3Vwc19ncm91cF9mdW5jdGlvbi9cIixcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBcIkRlbGV0ZSBhIGdyb3VwIGZyb20gY29nbml0b1wiLFxuICAgICAgICAgICAgaW5kZXg6IFwiaW5kZXgucHlcIixcbiAgICAgICAgICAgIGhhbmRsZXI6IFwibGFtYmRhX2hhbmRsZXJcIixcbiAgICAgICAgICAgIHRpbWVvdXQ6IER1cmF0aW9uLm1pbnV0ZXMoMSksXG4gICAgICAgICAgICBydW50aW1lOiBwcm9wcy5sYW1iZGFDb25maWcucnVudGltZSxcbiAgICAgICAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgICAgICAgIG1lbW9yeVNpemU6IDEyOCxcbiAgICAgICAgICAgIGFyY2hpdGVjdHVyZTogcHJvcHMubGFtYmRhQ29uZmlnLmFyY2hpdGVjdHVyZSxcbiAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgXCJ1c2VyX3Bvb2xfaWRcIjogcHJvcHMudXNlclBvb2xJZCxcbiAgICAgICAgICAgICAgICBcIlBPV0VSVE9PTFNfU0VSVklDRV9OQU1FXCI6IFwiZGVsZXRlX2dyb3Vwc19ncm91cFwiLFxuICAgICAgICAgICAgICAgIFwiTE9HX0xFVkVMXCI6IHByb3BzLmxhbWJkYUNvbmZpZy5sYXllcnNDb25maWcucG93ZXJUb29sc0xvZ0xldmVsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJ1bmRsaW5nOiB7XG4gICAgICAgICAgICAgICAgaW1hZ2U6IHByb3BzLmxhbWJkYUNvbmZpZy5idW5kbGluZ0ltYWdlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gbGF5ZXJzOiBbYmFzZV9zdGFjay5faGVscGVyX2Z1bmN0aW9uc19sYXllciwgYmFzZV9zdGFjay5fcG93ZXJ0b29sc19sYXllcl0sICAgICAvLyBUT0RPIHVuY29tbWVudCB3aGVuIGZpeGVkIGluIGJhc2Ugc3RhY2tcbiAgICAgICAgfSlcbiAgICAgICAgZGVsZXRlX2dyb3Vwc19ncm91cF9mdW5jdGlvbi5hZGRUb1JvbGVQb2xpY3koXG4gICAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAgXCJjb2duaXRvLWlkcDpEZWxldGVHcm91cFwiLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgcmVzb3VyY2VzOiBbcHJvcHMudXNlclBvb2xBcm5dLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuXG4gICAgICAgIC8vIEFQSSBSRVNPVVJDRVNcbiAgICAgICAgY29uc3QgdXNlcm5hbWVfZ3JvdXBuYW1lX21vZGVsID0gIHByb3BzLnJlc3RBcGkuYXBpLmFkZE1vZGVsKFxuICAgICAgICAgICAgXCJVc2VybmFtZUdyb3VwbmFtZU1vZGVsXCIsIHtcbiAgICAgICAgICAgIGNvbnRlbnRUeXBlOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgIHNjaGVtYToge1xuICAgICAgICAgICAgICAgIHNjaGVtYTogYXBpZy5Kc29uU2NoZW1hVmVyc2lvbi5EUkFGVDQsXG4gICAgICAgICAgICAgICAgdHlwZTogYXBpZy5Kc29uU2NoZW1hVHlwZS5PQkpFQ1QsXG4gICAgICAgICAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgICAgICAgICAgICBcInVzZXJuYW1lXCI6IHsgdHlwZTogYXBpZy5Kc29uU2NoZW1hVHlwZS5TVFJJTkcgfSxcbiAgICAgICAgICAgICAgICAgICAgXCJncm91cG5hbWVcIjogeyB0eXBlOiBhcGlnLkpzb25TY2hlbWFUeXBlLlNUUklORyB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gR0VUIC9hZG1pbi9ncm91cHNcbiAgICAgICAgY29uc3QgYXBpQWRtaW5Hcm91cHMgPSBwcm9wcy5yZXN0QXBpLmFwaUFkbWluUmVzb3VyY2UuYWRkUmVzb3VyY2UoXCJncm91cHNcIilcbiAgICAgICAgYXBpQWRtaW5Hcm91cHMuYWRkTWV0aG9kKFwiR0VUXCIsXG4gICAgICAgICAgICBuZXcgYXBpZy5MYW1iZGFJbnRlZ3JhdGlvbihnZXRfZ3JvdXBzX2Z1bmN0aW9uKSwge1xuICAgICAgICAgICAgYXV0aG9yaXphdGlvblR5cGU6IGFwaWcuQXV0aG9yaXphdGlvblR5cGUuSUFNLFxuICAgICAgICB9KVxuXG4gICAgICAgIC8vIFBVVCAvYWRtaW4vZ3JvdXBzXG4gICAgICAgIGFwaUFkbWluR3JvdXBzLmFkZE1ldGhvZChcIlBVVFwiLFxuICAgICAgICAgICAgbmV3IGFwaWcuTGFtYmRhSW50ZWdyYXRpb24ocHV0X2dyb3Vwc19ncm91cF9mdW5jdGlvbiksIHtcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBhcGlnLkF1dGhvcml6YXRpb25UeXBlLklBTSxcbiAgICAgICAgfSlcblxuICAgICAgICAvLyAvYWRtaW4vZ3JvdXBzL3tncm91cG5hbWV9XG4gICAgICAgIGNvbnN0IGdyb3VwID0gYXBpQWRtaW5Hcm91cHMuYWRkUmVzb3VyY2UoXCJ7Z3JvdXBuYW1lfVwiKVxuXG4gICAgICAgIC8vIEdFVCAvYWRtaW4vZ3JvdXBzL3tncm91cG5hbWV9XG4gICAgICAgIGdyb3VwLmFkZE1ldGhvZChcIkdFVFwiLFxuICAgICAgICAgICAgbmV3IGFwaWcuTGFtYmRhSW50ZWdyYXRpb24oZ2V0X2dyb3Vwc19ncm91cF9mdW5jdGlvbiksIHtcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBhcGlnLkF1dGhvcml6YXRpb25UeXBlLklBTSxcbiAgICAgICAgfSlcblxuICAgICAgICAvLyBERUxFVEUgL2FkbWluL2dyb3Vwcy97Z3JvdXBuYW1lfVxuICAgICAgICBncm91cC5hZGRNZXRob2QoXCJERUxFVEVcIixcbiAgICAgICAgICAgIG5ldyBhcGlnLkxhbWJkYUludGVncmF0aW9uKGRlbGV0ZV9ncm91cHNfZ3JvdXBfZnVuY3Rpb24pLCB7XG4gICAgICAgICAgICBhdXRob3JpemF0aW9uVHlwZTogYXBpZy5BdXRob3JpemF0aW9uVHlwZS5JQU0sXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gUE9TVCAvYWRtaW4vZ3JvdXBzL3tncm91cG5hbWV9XG4gICAgICAgIGdyb3VwLmFkZE1ldGhvZChcIlBPU1RcIixcbiAgICAgICAgICAgIG5ldyBhcGlnLkxhbWJkYUludGVncmF0aW9uKHBvc3RHcm91cHNHcm91cFVzZXJGdW5jdGlvbiksIHtcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBhcGlnLkF1dGhvcml6YXRpb25UeXBlLklBTSxcbiAgICAgICAgICAgIHJlcXVlc3RNb2RlbHM6IHsgXCJhcHBsaWNhdGlvbi9qc29uXCI6IHVzZXJuYW1lX2dyb3VwbmFtZV9tb2RlbCB9LFxuICAgICAgICAgICAgcmVxdWVzdFZhbGlkYXRvcjogcHJvcHMucmVzdEFwaS5ib2R5VmFsaWRhdG9yXG4gICAgICAgIH0pXG5cbiAgICAgICAgLy8gL2FkbWluL2dyb3Vwcy97Z3JvdXBuYW1lfS97dXNlcm5hbWV9XG4gICAgICAgIGNvbnN0IGdyb3VwX3VzZXIgPSBncm91cC5hZGRSZXNvdXJjZShcInt1c2VybmFtZX1cIilcblxuICAgICAgICAvLyBERUxFVEUgL2FkbWluL2dyb3Vwcy97Z3JvdXBuYW1lfS97dXNlcm5hbWV9XG4gICAgICAgIGdyb3VwX3VzZXIuYWRkTWV0aG9kKFwiREVMRVRFXCIsXG4gICAgICAgICAgICBuZXcgYXBpZy5MYW1iZGFJbnRlZ3JhdGlvbihkZWxldGVHcm91cHNHcm91cFVzZXJGdW5jdGlvbiksIHtcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb25UeXBlOiBhcGlnLkF1dGhvcml6YXRpb25UeXBlLklBTSxcbiAgICAgICAgfSlcbiAgICB9XG59XG4iXX0=
