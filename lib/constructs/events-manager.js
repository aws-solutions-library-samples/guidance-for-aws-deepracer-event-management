'use strict';
Object.defineProperty(exports, '__esModule', { value: true });
exports.EventsManager = void 0;
const lambdaPython = require('@aws-cdk/aws-lambda-python-alpha');
const aws_cdk_lib_1 = require('aws-cdk-lib');
const appsync = require('aws-cdk-lib/aws-appsync');
const dynamodb = require('aws-cdk-lib/aws-dynamodb');
const iam = require('aws-cdk-lib/aws-iam');
const lambda = require('aws-cdk-lib/aws-lambda');
const awscdk_appsync_utils_1 = require('awscdk-appsync-utils');
const constructs_1 = require('constructs');
class EventsManager extends constructs_1.Construct {
  constructor(scope, id, props) {
    super(scope, id);
    const events_table = new dynamodb.Table(this, 'EventsTable', {
      partitionKey: {
        name: 'eventId',
        type: dynamodb.AttributeType.STRING,
      },
      billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
      encryption: dynamodb.TableEncryption.AWS_MANAGED,
      removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
    });
    const events_handler = new lambdaPython.PythonFunction(this, 'eventsFunction', {
      entry: 'lib/lambdas/events_function/',
      description: 'Events Resolver',
      index: 'index.py',
      handler: 'lambda_handler',
      timeout: aws_cdk_lib_1.Duration.minutes(1),
      runtime: props.lambdaConfig.runtime,
      tracing: lambda.Tracing.ACTIVE,
      memorySize: 128,
      bundling: { image: props.lambdaConfig.bundlingImage },
      //            layers: [base_stack._powertools_layer], // TODO uncomment when fixed in base stack
      environment: {
        DDB_TABLE: events_table.tableName,
        user_pool_id: props.userPoolId,
        POWERTOOLS_SERVICE_NAME: 'events_resolver',
        LOG_LEVEL: props.lambdaConfig.layersConfig.powerToolsLogLevel,
      },
    });
    events_table.grantReadWriteData(events_handler);
    // Define the data source for the API
    const events_data_source = props.appsyncApi.api.addLambdaDataSource(
      'EventsDataSource',
      events_handler
    );
    // Define API Schema
    const events_object_Type = new awscdk_appsync_utils_1.ObjectType('Event', {
      definition: {
        eventId: awscdk_appsync_utils_1.GraphqlType.id(),
        createdAt: awscdk_appsync_utils_1.GraphqlType.awsDateTime(),
        eventName: awscdk_appsync_utils_1.GraphqlType.string(),
        eventDate: awscdk_appsync_utils_1.GraphqlType.awsDate(),
        fleetId: awscdk_appsync_utils_1.GraphqlType.id(),
        countryCode: awscdk_appsync_utils_1.GraphqlType.string(),
        raceRankingMethod: awscdk_appsync_utils_1.GraphqlType.string(),
        raceTimeInMin: awscdk_appsync_utils_1.GraphqlType.int(),
        raceNumberOfResets: awscdk_appsync_utils_1.GraphqlType.int(),
        raceLapsToFinish: awscdk_appsync_utils_1.GraphqlType.int(),
        raceTrackType: awscdk_appsync_utils_1.GraphqlType.string(),
      },
    });
    props.appsyncApi.schema.addType(events_object_Type);
    // Event methods
    props.appsyncApi.schema.addQuery(
      'getAllEvents',
      new awscdk_appsync_utils_1.ResolvableField({
        returnType: events_object_Type.attribute({ isList: true }),
        dataSource: events_data_source,
      })
    );
    props.appsyncApi.schema.addMutation(
      'addEvent',
      new awscdk_appsync_utils_1.ResolvableField({
        args: {
          eventName: awscdk_appsync_utils_1.GraphqlType.string({ isRequired: true }),
          eventDate: awscdk_appsync_utils_1.GraphqlType.awsDate(),
          fleetId: awscdk_appsync_utils_1.GraphqlType.id(),
          countryCode: awscdk_appsync_utils_1.GraphqlType.string(),
          raceRankingMethod: awscdk_appsync_utils_1.GraphqlType.string({ isRequired: true }),
          raceTimeInMin: awscdk_appsync_utils_1.GraphqlType.int({ isRequired: true }),
          raceNumberOfResets: awscdk_appsync_utils_1.GraphqlType.int({ isRequired: true }),
          raceLapsToFinish: awscdk_appsync_utils_1.GraphqlType.int({ isRequired: true }),
          raceTrackType: awscdk_appsync_utils_1.GraphqlType.string({ isRequired: true }),
        },
        returnType: events_object_Type.attribute(),
        dataSource: events_data_source,
      })
    );
    props.appsyncApi.schema.addSubscription(
      'onAddedEvent',
      new awscdk_appsync_utils_1.ResolvableField({
        returnType: events_object_Type.attribute(),
        dataSource: props.appsyncApi.noneDataSource,
        requestMappingTemplate: appsync.MappingTemplate.fromString(`{
                        "version": "2017-02-28",
                    "payload": $util.toJson($context.arguments.entry)
                    }`),
        responseMappingTemplate: appsync.MappingTemplate.fromString(
          '$util.toJson($context.result)'
        ),
        directives: [awscdk_appsync_utils_1.Directive.subscribe('addEvent')],
      })
    );
    props.appsyncApi.schema.addMutation(
      'deleteEvents',
      new awscdk_appsync_utils_1.ResolvableField({
        args: { eventIds: awscdk_appsync_utils_1.GraphqlType.string({ isRequiredList: true }) },
        returnType: events_object_Type.attribute({ isList: true }),
        dataSource: events_data_source,
      })
    );
    props.appsyncApi.schema.addSubscription(
      'onDeletedEvents',
      new awscdk_appsync_utils_1.ResolvableField({
        returnType: events_object_Type.attribute({ isList: true }),
        dataSource: props.appsyncApi.noneDataSource,
        requestMappingTemplate: appsync.MappingTemplate.fromString(`{
                        "version": "2017-02-28",
                        "payload": $util.toJson($context.arguments.entry)
                    }`),
        responseMappingTemplate: appsync.MappingTemplate.fromString(
          '$util.toJson($context.result)'
        ),
        directives: [awscdk_appsync_utils_1.Directive.subscribe('deleteEvents')],
      })
    );
    props.appsyncApi.schema.addMutation(
      'updateEvent',
      new awscdk_appsync_utils_1.ResolvableField({
        args: {
          eventId: awscdk_appsync_utils_1.GraphqlType.string({ isRequired: true }),
          eventName: awscdk_appsync_utils_1.GraphqlType.string(),
          eventDate: awscdk_appsync_utils_1.GraphqlType.awsDate(),
          fleetId: awscdk_appsync_utils_1.GraphqlType.id(),
          countryCode: awscdk_appsync_utils_1.GraphqlType.string(),
          raceTrackType: awscdk_appsync_utils_1.GraphqlType.string(),
          raceRankingMethod: awscdk_appsync_utils_1.GraphqlType.string(),
          raceTimeInMin: awscdk_appsync_utils_1.GraphqlType.int(),
          raceNumberOfResets: awscdk_appsync_utils_1.GraphqlType.int(),
          raceLapsToFinish: awscdk_appsync_utils_1.GraphqlType.int(),
        },
        returnType: events_object_Type.attribute(),
        dataSource: events_data_source,
      })
    );
    props.appsyncApi.schema.addSubscription(
      'onUpdatedEvent',
      new awscdk_appsync_utils_1.ResolvableField({
        returnType: events_object_Type.attribute(),
        dataSource: props.appsyncApi.noneDataSource,
        requestMappingTemplate: appsync.MappingTemplate.fromString(`{
                        "version": "2017-02-28",
                    "payload": $util.toJson($context.arguments.entry)
                    }`),
        responseMappingTemplate: appsync.MappingTemplate.fromString(
          '$util.toJson($context.result)'
        ),
        directives: [awscdk_appsync_utils_1.Directive.subscribe('updateEvent')],
      })
    );
    // // Grant access so API methods can be invoked
    // for role in roles_to_grant_invoke_access:
    const admin_api_policy = new iam.Policy(this, 'eventsManagerAdminApiPolicy', {
      statements: [
        new iam.PolicyStatement({
          effect: iam.Effect.ALLOW,
          actions: ['appsync:GraphQL'],
          resources: [
            `${props.appsyncApi.api.arn}/types/Query/fields/getAllEvents`,
            `${props.appsyncApi.api.arn}/types/Mutation/fields/addEvent`,
            `${props.appsyncApi.api.arn}/types/Subscription/fields/addedEvent`,
            `${props.appsyncApi.api.arn}/types/Mutation/fields/deleteEvent`,
            `${props.appsyncApi.api.arn}/types/Subscription/fields/deletedEvent`,
            `${props.appsyncApi.api.arn}/types/Mutation/fields/updateEvent`,
            `${props.appsyncApi.api.arn}/types/Subscription/fields/addedEvent`,
            `${props.appsyncApi.api.arn}/types/Subscription/fields/deletedEvent`,
            `${props.appsyncApi.api.arn}/types/Subscription/fields/updatedEvent`,
            `${props.appsyncApi.api.arn}/types/Mutation/fields/addTrack`,
            `${props.appsyncApi.api.arn}/types/Mutation/fields/deleteTrack`,
            `${props.appsyncApi.api.arn}/types/Mutation/fields/updateTrack`,
          ],
        }),
      ],
    });
    admin_api_policy.attachToRole(props.adminGroupRole);
  }
}
exports.EventsManager = EventsManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnRzLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJldmVudHMtbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxpRUFBaUU7QUFDakUsNkNBQW1FO0FBQ25FLG1EQUFtRDtBQUNuRCxxREFBcUQ7QUFDckQsMkNBQTJDO0FBRTNDLGlEQUFpRDtBQUNqRCwrREFBNEc7QUFHNUcsMkNBQXVDO0FBcUJ2QyxNQUFhLGFBQWMsU0FBUSxzQkFBUztJQUN4QyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXlCO1FBQy9ELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsTUFBTSxZQUFZLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUNuQyxJQUFJLEVBQ0osYUFBYSxFQUFFO1lBQ2YsWUFBWSxFQUFFO2dCQUNWLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTTthQUN2RDtZQUNELFdBQVcsRUFBRSxRQUFRLENBQUMsV0FBVyxDQUFDLGVBQWU7WUFDakQsVUFBVSxFQUFFLFFBQVEsQ0FBQyxlQUFlLENBQUMsV0FBVztZQUNoRCxhQUFhLEVBQUUsMkJBQWEsQ0FBQyxPQUFPO1NBQ3ZDLENBQUMsQ0FBQTtRQUVGLE1BQU0sY0FBYyxHQUFHLElBQUksWUFBWSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUU7WUFDM0UsS0FBSyxFQUFFLDhCQUE4QjtZQUNyQyxXQUFXLEVBQUUsaUJBQWlCO1lBQzlCLEtBQUssRUFBRSxVQUFVO1lBQ2pCLE9BQU8sRUFBRSxnQkFBZ0I7WUFDekIsT0FBTyxFQUFFLHNCQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUM1QixPQUFPLEVBQUUsS0FBSyxDQUFDLFlBQVksQ0FBQyxPQUFPO1lBQ25DLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU07WUFDOUIsVUFBVSxF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QUcseUNBQXlDO3dCQUNwRSxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcseUNBQXlDO3dCQUNwRSxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsaUNBQWlDO3dCQUM1RCxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsb0NBQW9DO3dCQUMvRCxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsb0NBQW9DO3FCQUNsRTtpQkFDSixDQUFDO2FBQ0w7U0FDSixDQUFDLENBQUE7UUFDRixnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFBO0lBQ3ZELENBQUM7Q0FDSjtBQXJNRCxzQ0FxTUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCAqIGFzIGxhbWJkYVB5dGhvbiBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhLXB5dGhvbi1hbHBoYSc7XG5pbXBvcnQgeyBEb2NrZXJJbWFnZSwgRHVyYXRpb24sIFJlbW92YWxQb2xpY3kgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBhcHBzeW5jIGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcHBzeW5jJztcbmltcG9ydCAqIGFzIGR5bmFtb2RiIGZyb20gJ2F3cy1jZGstbGliL2F3cy1keW5hbW9kYic7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBJUm9sZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgQ29kZUZpcnN0U2NoZW1hLCBEaXJlY3RpdmUsIEdyYXBocWxUeXBlLCBPYmplY3RUeXBlLCBSZXNvbHZhYmxlRmllbGQgfSBmcm9tICdhd3NjZGstYXBwc3luYy11dGlscyc7XG5cblxuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZlbnRzTWFuYWdlclByb3BzIHtcbiAgICBhZG1pbkdyb3VwUm9sZTogSVJvbGUsXG4gICAgdXNlclBvb2xJZDogc3RyaW5nLFxuICAgIGFwcHN5bmNBcGk6IHtcbiAgICAgICAgc2NoZW1hOiBDb2RlRmlyc3RTY2hlbWEsXG4gICAgICAgIGFwaTogYXBwc3luYy5JR3JhcGhxbEFwaVxuICAgICAgICBub25lRGF0YVNvdXJjZTogYXBwc3luYy5Ob25lRGF0YVNvdXJjZVxuICAgIH0sXG4gICAgbGFtYmRhQ29uZmlnOiB7XG4gICAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLFxuICAgICAgICBhcmNoaXRlY3R1cmU6IGxhbWJkYS5BcmNoaXRlY3R1cmUsXG4gICAgICAgIGJ1bmRsaW5nSW1hZ2U6IERvY2tlckltYWdlXG4gICAgICAgIGxheWVyc0NvbmZpZzoge1xuICAgICAgICAgICAgcG93ZXJUb29sc0xvZ0xldmVsOiBzdHJpbmdcbiAgICAgICAgfVxuICAgIH1cblxufVxuXG5leHBvcnQgY2xhc3MgRXZlbnRzTWFuYWdlciBleHRlbmRzIENvbnN0cnVjdCB7XG4gICAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IEV2ZW50c01hbmFnZXJQcm9wcykge1xuICAgICAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgICAgIGNvbnN0IGV2ZW50c190YWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZShcbiAgICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgICBcIkV2ZW50c1RhYmxlXCIsIHtcbiAgICAgICAgICAgIHBhcnRpdGlvbktleToge1xuICAgICAgICAgICAgICAgIG5hbWU6IFwiZXZlbnRJZFwiLCB0eXBlOiBkeW5hbW9kYi5BdHRyaWJ1dGVUeXBlLlNUUklOR1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJpbGxpbmdNb2RlOiBkeW5hbW9kYi5CaWxsaW5nTW9kZS5QQVlfUEVSX1JFUVVFU1QsXG4gICAgICAgICAgICBlbmNyeXB0aW9uOiBkeW5hbW9kYi5UYWJsZUVuY3J5cHRpb24uQVdTX01BTkFHRUQsXG4gICAgICAgICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICAgIH0pXG5cbiAgICAgICAgY29uc3QgZXZlbnRzX2hhbmRsZXIgPSBuZXcgbGFtYmRhUHl0aG9uLlB5dGhvbkZ1bmN0aW9uKHRoaXMsIFwiZXZlbnRzRnVuY3Rpb25cIiwge1xuICAgICAgICAgICAgZW50cnk6IFwibGliL2xhbWJkYXMvZXZlbnRzX2Z1bmN0aW9uL1wiLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IFwiRXZlbnRzIFJlc29sdmVyXCIsXG4gICAgICAgICAgICBpbmRleDogXCJpbmRleC5weVwiLFxuICAgICAgICAgICAgaGFuZGxlcjogXCJsYW1iZGFfaGFuZGxlclwiLFxuICAgICAgICAgICAgdGltZW91dDogRHVyYXRpb24ubWludXRlcygxKSxcbiAgICAgICAgICAgIHJ1bnRpbWU6IHByb3BzLmxhbWJkYUNvbmZpZy5ydW50aW1lLFxuICAgICAgICAgICAgdHJhY2luZzogbGFtYmRhLlRyYWNpbmcuQUNUSVZFLFxuICAgICAgICAgICAgbWVtb3J5U2l6ZTogMTI4LFxuICAgICAgICAgICAgYnVuZGxpbmc6IHsgaW1hZ2U6IHByb3BzLmxhbWJkYUNvbmZpZy5idW5kbGluZ0ltYWdlIH0sXG4gICAgICAgICAgICAvLyAgICAgICAgICAgIGxheWVyczogW2Jhc2Vfc3RhY2suX3Bvd2VydG9vbHNfbGF5ZXJdLCAvLyBUT0RPIHVuY29tbWVudCB3aGVuIGZpeGVkIGluIGJhc2Ugc3RhY2tcbiAgICAgICAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgICAgICAgICAgXCJEREJfVEFCTEVcIjogZXZlbnRzX3RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgICAgICAgICBcInVzZXJfcG9vbF9pZFwiOiBwcm9wcy51c2VyUG9vbElkLFxuICAgICAgICAgICAgICAgIFwiUE9XRVJUT09MU19TRVJWSUNFX05BTUVcIjogXCJldmVudHNfcmVzb2x2ZXJcIixcbiAgICAgICAgICAgICAgICBcIkxPR19MRVZFTFwiOiBwcm9wcy5sYW1iZGFDb25maWcubGF5ZXJzQ29uZmlnLnBvd2VyVG9vbHNMb2dMZXZlbCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pXG5cbiAgICAgICAgZXZlbnRzX3RhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShldmVudHNfaGFuZGxlcilcblxuICAgICAgICAvLyBEZWZpbmUgdGhlIGRhdGEgc291cmNlIGZvciB0aGUgQVBJXG4gICAgICAgIGNvbnN0IGV2ZW50c19kYXRhX3NvdXJjZSA9IHByb3BzLmFwcHN5bmNBcGkuYXBpLmFkZExhbWJkYURhdGFTb3VyY2UoXG4gICAgICAgICAgICBcIkV2ZW50c0RhdGFTb3VyY2VcIiwgZXZlbnRzX2hhbmRsZXJcbiAgICAgICAgKVxuXG4gICAgICAgIC8vIERlZmluZSBBUEkgU2NoZW1hXG5cbiAgICAgICAgY29uc3QgZXZlbnRzX29iamVjdF9UeXBlID0gbmV3IE9iamVjdFR5cGUoXG4gICAgICAgICAgICBcIkV2ZW50XCIsIHtcbiAgICAgICAgICAgIGRlZmluaXRpb246IHtcbiAgICAgICAgICAgICAgICBcImV2ZW50SWRcIjogR3JhcGhxbFR5cGUuaWQoKSxcbiAgICAgICAgICAgICAgICBcImNyZWF0ZWRBdFwiOiBHcmFwaHFsVHlwZS5hd3NEYXRlVGltZSgpLFxuICAgICAgICAgICAgICAgIFwiZXZlbnROYW1lXCI6IEdyYXBocWxUeXBlLnN0cmluZygpLFxuICAgICAgICAgICAgICAgIFwiZXZlbnREYXRlXCI6IEdyYXBocWxUeXBlLmF3c0RhdGUoKSxcbiAgICAgICAgICAgICAgICBcImZsZWV0SWRcIjogR3JhcGhxbFR5cGUuaWQoKSxcbiAgICAgICAgICAgICAgICBcImNvdW50cnlDb2RlXCI6IEdyYXBocWxUeXBlLnN0cmluZygpLFxuICAgICAgICAgICAgICAgIFwicmFjZVJhbmtpbmdNZXRob2RcIjogR3JhcGhxbFR5cGUuc3RyaW5nKCksXG4gICAgICAgICAgICAgICAgXCJyYWNlVGltZUluTWluXCI6IEdyYXBocWxUeXBlLmludCgpLFxuICAgICAgICAgICAgICAgIFwicmFjZU51bWJlck9mUmVzZXRzXCI6IEdyYXBocWxUeXBlLmludCgpLFxuICAgICAgICAgICAgICAgIFwicmFjZUxhcHNUb0ZpbmlzaFwiOiBHcmFwaHFsVHlwZS5pbnQoKSxcbiAgICAgICAgICAgICAgICBcInJhY2VUcmFja1R5cGVcIjogR3JhcGhxbFR5cGUuc3RyaW5nKCksXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KVxuXG4gICAgICAgIHByb3BzLmFwcHN5bmNBcGkuc2NoZW1hLmFkZFR5cGUoZXZlbnRzX29iamVjdF9UeXBlKVxuXG4gICAgICAgIC8vIEV2ZW50IG1ldGhvZHNcbiAgICAgICAgcHJvcHMuYXBwc3luY0FwaS5zY2hlbWEuYWRkUXVlcnkoXG4gICAgICAgICAgICBcImdldEFsbEV2ZW50c1wiLFxuICAgICAgICAgICAgbmV3IFJlc29sdmFibGVGaWVsZCh7XG4gICAgICAgICAgICAgICAgcmV0dXJuVHlwZTogZXZlbnRzX29iamVjdF9UeXBlLmF0dHJpYnV0ZSh7IGlzTGlzdDogdHJ1ZSB9KSxcbiAgICAgICAgICAgICAgICBkYXRhU291cmNlOiBldmVudHNfZGF0YV9zb3VyY2UsXG4gICAgICAgICAgICB9KSlcblxuICAgICAgICBwcm9wcy5hcHBzeW5jQXBpLnNjaGVtYS5hZGRNdXRhdGlvbihcbiAgICAgICAgICAgIFwiYWRkRXZlbnRcIixcbiAgICAgICAgICAgIG5ldyBSZXNvbHZhYmxlRmllbGQoe1xuICAgICAgICAgICAgICAgIGFyZ3M6IHtcbiAgICAgICAgICAgICAgICAgICAgXCJldmVudE5hbWVcIjogR3JhcGhxbFR5cGUuc3RyaW5nKHsgaXNSZXF1aXJlZDogdHJ1ZSB9KSxcbiAgICAgICAgICAgICAgICAgICAgXCJldmVudERhdGVcIjogR3JhcGhxbFR5cGUuYXdzRGF0ZSgpLFxuICAgICAgICAgICAgICAgICAgICBcImZsZWV0SWRcIjogR3JhcGhxbFR5cGUuaWQoKSxcbiAgICAgICAgICAgICAgICAgICAgXCJjb3VudHJ5Q29kZVwiOiBHcmFwaHFsVHlwZS5zdHJpbmcoKSxcbiAgICAgICAgICAgICAgICAgICAgXCJyYWNlUmFua2luZ01ldGhvZFwiOiBHcmFwaHFsVHlwZS5zdHJpbmcoeyBpc1JlcXVpcmVkOiB0cnVlIH0pLFxuICAgICAgICAgICAgICAgICAgICBcInJhY2VUaW1lSW5NaW5cIjogR3JhcGhxbFR5cGUuaW50KHsgaXNSZXF1aXJlZDogdHJ1ZSB9KSxcbiAgICAgICAgICAgICAgICAgICAgXCJyYWNlTnVtYmVyT2ZSZXNldHNcIjogR3JhcGhxbFR5cGUuaW50KHsgaXNSZXF1aXJlZDogdHJ1ZSB9KSxcbiAgICAgICAgICAgICAgICAgICAgXCJyYWNlTGFwc1RvRmluaXNoXCI6IEdyYXBocWxUeXBlLmludCh7IGlzUmVxdWlyZWQ6IHRydWUgfSksXG4gICAgICAgICAgICAgICAgICAgIFwicmFjZVRyYWNrVHlwZVwiOiBHcmFwaHFsVHlwZS5zdHJpbmcoeyBpc1JlcXVpcmVkOiB0cnVlIH0pLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcmV0dXJuVHlwZTogZXZlbnRzX29iamVjdF9UeXBlLmF0dHJpYnV0ZSgpLFxuICAgICAgICAgICAgICAgIGRhdGFTb3VyY2U6IGV2ZW50c19kYXRhX3NvdXJjZSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICApXG4gICAgICAgIHByb3BzLmFwcHN5bmNBcGkuc2NoZW1hLmFkZFN1YnNjcmlwdGlvbihcbiAgICAgICAgICAgIFwib25BZGRlZEV2ZW50XCIsXG4gICAgICAgICAgICBuZXcgUmVzb2x2YWJsZUZpZWxkKHtcbiAgICAgICAgICAgICAgICByZXR1cm5UeXBlOiBldmVudHNfb2JqZWN0X1R5cGUuYXR0cmlidXRlKCksXG4gICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogcHJvcHMuYXBwc3luY0FwaS5ub25lRGF0YVNvdXJjZSxcbiAgICAgICAgICAgICAgICByZXF1ZXN0TWFwcGluZ1RlbXBsYXRlOiBhcHBzeW5jLk1hcHBpbmdUZW1wbGF0ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICBge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ2ZXJzaW9uXCI6IFwiMjAxNy0wMi0yOFwiLFxuICAgICAgICAgICAgICAgICAgICBcInBheWxvYWRcIjogJHV0aWwudG9Kc29uKCRjb250ZXh0LmFyZ3VtZW50cy5lbnRyeSlcbiAgICAgICAgICAgICAgICAgICAgfWBcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBhcHBzeW5jLk1hcHBpbmdUZW1wbGF0ZS5mcm9tU3RyaW5nXG4gICAgICAgICAgICAgICAgICAgIChcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiJHV0aWwudG9Kc29uKCRjb250ZXh0LnJlc3VsdClcIlxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXM6IFtEaXJlY3RpdmUuc3Vic2NyaWJlKFwiYWRkRXZlbnRcIildLFxuICAgICAgICAgICAgfSksXG4gICAgICAgIClcblxuICAgICAgICBwcm9wcy5hcHBzeW5jQXBpLnNjaGVtYS5hZGRNdXRhdGlvbihcbiAgICAgICAgICAgIFwiZGVsZXRlRXZlbnRzXCIsXG4gICAgICAgICAgICBuZXcgUmVzb2x2YWJsZUZpZWxkKHtcbiAgICAgICAgICAgICAgICBhcmdzOiB7IFwiZXZlbnRJZHNcIjogR3JhcGhxbFR5cGUuc3RyaW5nKHsgaXNSZXF1aXJlZExpc3Q6IHRydWUgfSkgfSxcbiAgICAgICAgICAgICAgICByZXR1cm5UeXBlOiBldmVudHNfb2JqZWN0X1R5cGUuYXR0cmlidXRlKHsgaXNMaXN0OiB0cnVlIH0pLFxuICAgICAgICAgICAgICAgIGRhdGFTb3VyY2U6IGV2ZW50c19kYXRhX3NvdXJjZSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICApXG4gICAgICAgIHByb3BzLmFwcHN5bmNBcGkuc2NoZW1hLmFkZFN1YnNjcmlwdGlvbihcbiAgICAgICAgICAgIFwib25EZWxldGVkRXZlbnRzXCIsXG4gICAgICAgICAgICBuZXcgUmVzb2x2YWJsZUZpZWxkKHtcbiAgICAgICAgICAgICAgICByZXR1cm5UeXBlOiBldmVudHNfb2JqZWN0X1R5cGUuYXR0cmlidXRlKHsgaXNMaXN0OiB0cnVlIH0pLFxuICAgICAgICAgICAgICAgIGRhdGFTb3VyY2U6IHByb3BzLmFwcHN5bmNBcGkubm9uZURhdGFTb3VyY2UsXG4gICAgICAgICAgICAgICAgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZTogYXBwc3luYy5NYXBwaW5nVGVtcGxhdGUuZnJvbVN0cmluZyhcbiAgICAgICAgICAgICAgICAgICAgYHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFwidmVyc2lvblwiOiBcIjIwMTctMDItMjhcIixcbiAgICAgICAgICAgICAgICAgICAgICAgIFwicGF5bG9hZFwiOiAkdXRpbC50b0pzb24oJGNvbnRleHQuYXJndW1lbnRzLmVudHJ5KVxuICAgICAgICAgICAgICAgICAgICB9YFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGU6IGFwcHN5bmMuTWFwcGluZ1RlbXBsYXRlLmZyb21TdHJpbmcoXG4gICAgICAgICAgICAgICAgICAgIFwiJHV0aWwudG9Kc29uKCRjb250ZXh0LnJlc3VsdClcIlxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgZGlyZWN0aXZlczogW0RpcmVjdGl2ZS5zdWJzY3JpYmUoXCJkZWxldGVFdmVudHNcIildLFxuICAgICAgICAgICAgfSksXG4gICAgICAgIClcblxuICAgICAgICBwcm9wcy5hcHBzeW5jQXBpLnNjaGVtYS5hZGRNdXRhdGlvbihcbiAgICAgICAgICAgIFwidXBkYXRlRXZlbnRcIixcbiAgICAgICAgICAgIG5ldyBSZXNvbHZhYmxlRmllbGQoe1xuICAgICAgICAgICAgICAgIGFyZ3M6IHtcbiAgICAgICAgICAgICAgICAgICAgXCJldmVudElkXCI6IEdyYXBocWxUeXBlLnN0cmluZyh7IGlzUmVxdWlyZWQ6IHRydWUgfSksXG4gICAgICAgICAgICAgICAgICAgIFwiZXZlbnROYW1lXCI6IEdyYXBocWxUeXBlLnN0cmluZygpLFxuICAgICAgICAgICAgICAgICAgICBcImV2ZW50RGF0ZVwiOiBHcmFwaHFsVHlwZS5hd3NEYXRlKCksXG4gICAgICAgICAgICAgICAgICAgIFwiZmxlZXRJZFwiOiBHcmFwaHFsVHlwZS5pZCgpLFxuICAgICAgICAgICAgICAgICAgICBcImNvdW50cnlDb2RlXCI6IEdyYXBocWxUeXBlLnN0cmluZygpLFxuICAgICAgICAgICAgICAgICAgICBcInJhY2VUcmFja1R5cGVcIjogR3JhcGhxbFR5cGUuc3RyaW5nKCksXG4gICAgICAgICAgICAgICAgICAgIFwicmFjZVJhbmtpbmdNZXRob2RcIjogR3JhcGhxbFR5cGUuc3RyaW5nKCksXG4gICAgICAgICAgICAgICAgICAgIFwicmFjZVRpbWVJbk1pblwiOiBHcmFwaHFsVHlwZS5pbnQoKSxcbiAgICAgICAgICAgICAgICAgICAgXCJyYWNlTnVtYmVyT2ZSZXNldHNcIjogR3JhcGhxbFR5cGUuaW50KCksXG4gICAgICAgICAgICAgICAgICAgIFwicmFjZUxhcHNUb0ZpbmlzaFwiOiBHcmFwaHFsVHlwZS5pbnQoKSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHJldHVyblR5cGU6IGV2ZW50c19vYmplY3RfVHlwZS5hdHRyaWJ1dGUoKSxcbiAgICAgICAgICAgICAgICBkYXRhU291cmNlOiBldmVudHNfZGF0YV9zb3VyY2UsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgKVxuICAgICAgICBwcm9wcy5hcHBzeW5jQXBpLnNjaGVtYS5hZGRTdWJzY3JpcHRpb24oXG4gICAgICAgICAgICBcIm9uVXBkYXRlZEV2ZW50XCIsXG4gICAgICAgICAgICBuZXcgUmVzb2x2YWJsZUZpZWxkKHtcbiAgICAgICAgICAgICAgICByZXR1cm5UeXBlOiBldmVudHNfb2JqZWN0X1R5cGUuYXR0cmlidXRlKCksXG4gICAgICAgICAgICAgICAgZGF0YVNvdXJjZTogcHJvcHMuYXBwc3luY0FwaS5ub25lRGF0YVNvdXJjZSxcbiAgICAgICAgICAgICAgICByZXF1ZXN0TWFwcGluZ1RlbXBsYXRlOiBhcHBzeW5jLk1hcHBpbmdUZW1wbGF0ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICBge1xuICAgICAgICAgICAgICAgICAgICAgICAgXCJ2ZXJzaW9uXCI6IFwiMjAxNy0wMi0yOFwiLFxuICAgICAgICAgICAgICAgICAgICBcInBheWxvYWRcIjogJHV0aWwudG9Kc29uKCRjb250ZXh0LmFyZ3VtZW50cy5lbnRyeSlcbiAgICAgICAgICAgICAgICAgICAgfWBcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBhcHBzeW5jLk1hcHBpbmdUZW1wbGF0ZS5mcm9tU3RyaW5nKFxuICAgICAgICAgICAgICAgICAgICBcIiR1dGlsLnRvSnNvbigkY29udGV4dC5yZXN1bHQpXCJcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgIGRpcmVjdGl2ZXM6IFtEaXJlY3RpdmUuc3Vic2NyaWJlKFwidXBkYXRlRXZlbnRcIildLFxuICAgICAgICAgICAgfSksXG4gICAgICAgIClcblxuICAgICAgICAvLyAvLyBHcmFudCBhY2Nlc3Mgc28gQVBJIG1ldGhvZHMgY2FuIGJlIGludm9rZWRcbiAgICAgICAgLy8gZm9yIHJvbGUgaW4gcm9sZXNfdG9fZ3JhbnRfaW52b2tlX2FjY2VzczpcblxuICAgICAgICBjb25zdCBhZG1pbl9hcGlfcG9saWN5ID0gbmV3IGlhbS5Qb2xpY3kodGhpcywgXCJldmVudHNNYW5hZ2VyQWRtaW5BcGlQb2xpY3lcIiwge1xuICAgICAgICAgICAgc3RhdGVtZW50czogW1xuICAgICAgICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgICAgICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XLFxuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zOiBbXCJhcHBzeW5jOkdyYXBoUUxcIl0sXG4gICAgICAgICAgICAgICAgICAgIHJlc291cmNlczogW1xuICAgICAgICAgICAgICAgICAgICAgICAgYCR7cHJvcHMuYXBwc3luY0FwaS5hcGkuYXJufS90eXBlcy9RdWVyeS9maWVsZHMvZ2V0QWxsRXZlbnRzYCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3Byb3BzLmFwcHN5bmNBcGkuYXBpLmFybn0vdHlwZXMvTXV0YXRpb24vZmllbGRzL2FkZEV2ZW50YCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3Byb3BzLmFwcHN5bmNBcGkuYXBpLmFybn0vdHlwZXMvU3Vic2NyaXB0aW9uL2ZpZWxkcy9hZGRlZEV2ZW50YCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3Byb3BzLmFwcHN5bmNBcGkuYXBpLmFybn0vdHlwZXMvTXV0YXRpb24vZmllbGRzL2RlbGV0ZUV2ZW50YCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3Byb3BzLmFwcHN5bmNBcGkuYXBpLmFybn0vdHlwZXMvU3Vic2NyaXB0aW9uL2ZpZWxkcy9kZWxldGVkRXZlbnRgLFxuICAgICAgICAgICAgICAgICAgICAgICAgYCR7cHJvcHMuYXBwc3luY0FwaS5hcGkuYXJufS90eXBlcy9NdXRhdGlvbi9maWVsZHMvdXBkYXRlRXZlbnRgLFxuICAgICAgICAgICAgICAgICAgICAgICAgYCR7cHJvcHMuYXBwc3luY0FwaS5hcGkuYXJufS90eXBlcy9TdWJzY3JpcHRpb24vZmllbGRzL2FkZGVkRXZlbnRgLFxuICAgICAgICAgICAgICAgICAgICAgICAgYCR7cHJvcHMuYXBwc3luY0FwaS5hcGkuYXJufS90eXBlcy9TdWJzY3JpcHRpb24vZmllbGRzL2RlbGV0ZWRFdmVudGAsXG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtwcm9wcy5hcHBzeW5jQXBpLmFwaS5hcm59L3R5cGVzL1N1YnNjcmlwdGlvbi9maWVsZHMvdXBkYXRlZEV2ZW50YCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3Byb3BzLmFwcHN5bmNBcGkuYXBpLmFybn0vdHlwZXMvTXV0YXRpb24vZmllbGRzL2FkZFRyYWNrYCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3Byb3BzLmFwcHN5bmNBcGkuYXBpLmFybn0vdHlwZXMvTXV0YXRpb24vZmllbGRzL2RlbGV0ZVRyYWNrYCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGAke3Byb3BzLmFwcHN5bmNBcGkuYXBpLmFybn0vdHlwZXMvTXV0YXRpb24vZmllbGRzL3VwZGF0ZVRyYWNrYCxcbiAgICAgICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSlcbiAgICAgICAgYWRtaW5fYXBpX3BvbGljeS5hdHRhY2hUb1JvbGUocHJvcHMuYWRtaW5Hcm91cFJvbGUpXG4gICAgfVxufSJdfQ==
